/*HEADER******************************************************************************************
*
* Comments:
*
*
**END********************************************************************************************/
///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Includes Section                        
///////////////////////////////////////////////////////////////////////////////////////////////////
#include "derivative.h"
#include <stdint.h>
#include "NVIC.h"
#include "LPTimer.h"
///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Defines & Macros Section                   
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                       Typedef Section                        
///////////////////////////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////////////////////////////
//                                  Function Prototypes Section                 
///////////////////////////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Global Constants Section                   
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Static Constants Section                   
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Global Variables Section                   
///////////////////////////////////////////////////////////////////////////////////////////////////
//! Holds the interrupt events
volatile uint8_t LPTimer_gbStatus = 0;
///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Static Variables Section                   
///////////////////////////////////////////////////////////////////////////////////////////////////




///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Functions Section                       
///////////////////////////////////////////////////////////////////////////////////////////////////
void LPTimer_Init(uint8_t bPrescaler,uint8_t bClockSource, uint32_t dwCompareValue)
{
	/* Enable the clock gate */
	SIM_SCGC5 |= SIM_SCGC5_LPTMR_MASK;
	
	LPTMR0_CSR &= ~LPTMR_CSR_TEN_MASK;
	
	/* Interrupt enabled, interrupt on CMR match */
	LPTMR0_CSR |= LPTMR_CSR_TIE_MASK;
	
	/* keep only the 16 bits that the CMR supports */
	dwCompareValue &= 0xFFFF;
	LPTMR0_CMR = dwCompareValue;
	
	/* select prescaler and clock source */
	LPTMR0_PSR = LPTMR_PSR_PRESCALE(bPrescaler)|LPTMR_PSR_PCS(bClockSource);
	
	LPTimer_gbStatus = 0;
	
	/* Enable the timer interrupt*/
	LPTMR0_CSR |= LPTMR_CSR_TCF_MASK;
	/* Enable the interrupt */ 
	NVIC_vfnEnableIRQ(NVIC_LPTIMER);
	
	
}

void LPTimer_EnableTimer (void)
{
	/* Start the timer */
	LPTMR0_CSR |= LPTMR_CSR_TEN_MASK;
}

void LPTimer_IRQHandler (void)
{
	/* Clear the timer flag and set the proper event */
	LPTMR0_CSR |= LPTMR_CSR_TCF_MASK;
	
	LPTIMER_SET_STATUS(LPTIMER_COUNTER_MATCH_MASK_STATUS);
}


///////////////////////////////////////////////////////////////////////////////////////////////////
// EOF
///////////////////////////////////////////////////////////////////////////////////////////////////
